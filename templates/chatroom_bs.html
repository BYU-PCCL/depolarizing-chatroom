<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chatroom</title>
    {%include "boilerplate_bs.html" %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <link href="{{url_for('static', filename='css/chatroom.css')}}" rel="stylesheet">
</head>
<body>
    <section >
      <div class="container py-5">
        <div class="row">
          <h1>{{prompt}}</h1>
          <p> <span class="text-primary msg-count">{{msg_count}}</span> messages sent out of {{msg_limit}} required</p>
        </div>
        <div class="row">
          <div class="col-md-12">

            <div class="card" id="chat3" style="border-radius: 15px;">
              <div class="card-body">

                <div class="row justify-content-center">

                  <div class="col-md-8 col-lg-10 col-xl-12">

                    <div class="pt-3 pe-3 overflow-auto" data-mdb-perfect-scrollbar="true" id=chatbox style="position: relative; height: 60vh">
                      {% for msg in msgs %}
                      <div class="d-flex flex-row justify-content-{{"start" if msg.bot else "end"}}">
                        <div>
                          <p class="medium p-2 ms-3 mb-1 rounded-3 {{"bg-primary" if not msg.bot else "bg-light"}} {{"text-light" if not msg.bot}}" >{{msg.msg}}</p>
                          <p class="small ms-3 mb-3 rounded-3 text-muted float-end">{{msg.sendtime|format_dt}}</p>
                        </div>
                      </div>
                      {% endfor %}

                    </div>

                    <div class="text-muted d-flex justify-content-start align-items-center pe-3 pt-3 mt-2 border-top">
                      <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava6-bg.webp"
                        alt="avatar 3" style="width: 40px; height: 100%;">

                        <form class="d-flex justify-content-around w-100">
                          <input id="messagebox"
                            type="text"
                            class="form-control form-control-lg border-bottom"
                            placeholder="Type message"
                            aria-label="Type message"
                            aria-describedby="send-btn"
                          />
                          <button class="btn btn-outline-primary" style="border-radius:50%; border-top-left-radius: 0; border-bottom-left-radius:0;" type="submit" id="send-btn" data-mdb-ripple-color="dark">
                            Send
                          </button>
                        </form>


                    </div>

                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

<!-- after send, choose between original and gpt message -->
<div class="modal" id="msg-choice"
    tabindex="-1"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true"
    data-mdb-backdrop="static"
    data-mdb-keyboard="false"
    >
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Confirm message send</h5>
      </div>
      <div class="modal-body">
              <p class="border-bottom pb-3 text-secondary" id="original-msg"></p>
              <p class=" text-primary" id="translated-msg"></p>
      </div>
      <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-secondary" id="original-btn">Send original message</button>
          <button type="button" class="btn btn-primary" id="new-btn">Send new message</button>
      </div>
    </div>
  </div>
</div>

<!-- confirm modal at start -->
<div
  class="modal"
  id="confirm-modal"
  data-mdb-backdrop="static"
  data-mdb-keyboard="false"
  tabindex="-1"
  aria-labelledby="staticBackdropLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">Chat terms</h5>
      </div>
      <div class="modal-body">
          ...
      </div>
      <div class="modal-footer justify-content-between">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="confirm-check" />
            <label class="form-check-label" for="confirm-check">I have read and understand the terms of the chat</label>
          </div>
        <button type="button" class="btn btn-primary" id="confirm-btn" disabled>Confirm</button>
      </div>
    </div>
  </div>
</div>


  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script type="text/javascript">
// scroll to bottom of chats
$("#chatbox").scrollTop($("#chatbox").prop("scrollHeight"));
// variables for choosing message
var original = "";
var translation = "";

/** confirm modal **/
$('#confirm-btn').click(function() {
    console.log('click');
    $('#confirm-modal').modal('toggle');
});

$('#confirm-check').change(function(){
    if(this.checked){
        $('#confirm-btn').prop('disabled', false)
    } else {
        $('#confirm-btn').prop('disabled', true)
    }
})

/** message send choice **/
$("#original-btn").click(function(){
    send_to_server(original, false);
    $("#msg-choice").modal("toggle");
})

$("#new-btn").click(function(){
    send_to_server(translation, true);
    $("#msg-choice").modal("toggle");
})

function send_to_server(msg, is_bot){
    socket.emit('new_msg', {
        uid : {{uid}},
        msg : msg,
        is_bot : is_bot,
        cid : {{cid}}
    })
}

// function to add chaat
function addchat(msg, sent, bot){
    let ins = `
    <div class="d-flex flex-row justify-content-${sent ? "end" : "start"}">
      <div>
        <p class="small p-2 ms-3 mb-1 rounded-3 ${sent ? "bg-primary" : "bg-light"} ${ sent ? "text-light":""}" >${msg}</p>
        <p class="small ms-3 mb-3 rounded-3 float-end text-${bot ? "success" : "secondary"}">${bot ? "New message by GPT-3" : "Original message from sender"}</p>
      </div>
    </div>
    `;
    $('#chatbox').append(ins);
}

function display_choices(og, trans){
    $("#original-msg").html(og);
    $("#translated-msg").html(trans);
    $("#msg-choice").modal("toggle");
    // set variables for send to server
    original = og;
    translation = trans;
}

// connect socket
var socket = io.connect();

socket.on( 'connect', function() {

  var form = $( 'form' ).on( 'submit', function( e ) {
    e.preventDefault();
    let user_input = $( '#messagebox' ).val()
    if (user_input == ""){
      return;
    };
    $("#chatbox").scrollTop($("#chatbox").prop("scrollHeight"));

    socket.emit( 'post', {
      uname : "{{uname}}",
      uid : {{uid}},
      body : user_input,
      color : "{{color}}",
      cid : {{cid}}
    } );
    // clear textarea
    $('#messagebox').val('');
    // play send sound
    //document.getElementById("sent_sound").play()
    // ELIZA
    //console.log("sending eliza")
    //socket.emit( 'eliza', {msg : user_input})

    //$( 'textarea.message_box' ).val( '' ).focus()
  } );
});

socket.on( 'response_{{cid}}_{{uid}}', function( msg ) {

  display_choices(msg["body"], msg["response"]);
});

socket.on('new_msg_{{cid}}', function( msg ){
    if ("redirect" in msg){
        window.location.replace(msg["redirect"]);
    }
    addchat(msg["msg"], msg["uid"] == {{uid}}, msg["is_bot"]);
    $(".msg-count").html(msg["ct"]);
    $("#chatbox").scrollTop($("#chatbox").prop("scrollHeight"));
})

$(document).ready(function(){
    $('#confirm-modal').modal('toggle');
});
  </script>
 <script src="{{url_for('static', filename='js/mdb.min.js')}}"></script>

</body>
</html>
